var wt=Object.defineProperty;var vn=(n,e,t)=>e in n?wt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var f=(n,e)=>()=>(n&&(e=n(n=0)),e);var Oe=(n,e)=>{for(var t in e)wt(n,t,{get:e[t],enumerable:!0})};var vt=(n,e,t)=>vn(n,typeof e!="symbol"?e+"":e,t);var Ct={};Oe(Ct,{AppState:()=>i,BASE_OCTAVE_MIDI:()=>bn,CANVAS_HEIGHT_RATIOS:()=>Ve,DEFAULT_FUNDAMENTAL:()=>bt,DEFAULT_MASTER_GAIN:()=>St,DEFAULT_MASTER_SLEW:()=>Et,DEFAULT_MIDI_NOTE:()=>yt,DEFAULT_OCTAVE:()=>At,DRAWBAR_STYLES:()=>He,HARMONIC_COLORS:()=>qe,MIDI_NOTE_NAMES:()=>Ne,NUM_HARMONICS:()=>xt,VISUAL_HARMONIC_TERMS:()=>yn,WAVETABLE_SIZE:()=>Ge,getCurrentSystem:()=>xn,getHarmonicAmplitude:()=>En,resetHarmonicAmplitudes:()=>An,setCurrentSystem:()=>Sn,setHarmonicAmplitude:()=>Cn,spectralSystems:()=>R,updateAppState:()=>v});function v(n){Object.assign(i,n)}function An(){i.harmonicAmplitudes.fill(0),i.harmonicAmplitudes[0]=1}function xn(){return i.currentSystem}function Sn(n){i.currentSystem=R[n]}function En(n){return i.harmonicAmplitudes[n]||0}function Cn(n,e){n>=0&&n<i.harmonicAmplitudes.length&&(i.harmonicAmplitudes[n]=e)}var R,Ne,bt,yt,At,bn,Ge,xt,St,Et,yn,Ve,qe,He,i,A=f(()=>{R=[{name:"1. Harmonic Overtone Series (Integer)",description:'Classic harmonic series (exact integer partials). Use for natural, consonant spectra (e.g. voiced instruments, organ-like timbres). See the harmonic-series background: <a href="https://en.wikipedia.org/wiki/Harmonic_series_(music)">Wikipedia \u2014 Harmonic series</a>.',ratios:[1,2,3,4,5,6,7,8,9,10,11,12],labels:["1:1","2:1","3:1","4:1","5:1","6:1","7:1","8:1","9:1","10:1","11:1","12:1"],labelPrecision:1},{name:"2. Spectral Progressive Detuned Harmonics (Microtonal)",description:"Progressive microtonal detuning of the integer harmonic series. Detuning increases with partial index to produce time-varying beating and spectral shimmer (useful for spectral / ambient textures). This is an intentional synthesis choice rather than a canonical acoustic law.",ratios:[1,2.01,3.02,4.03,5.04,6.05,7.06,8.08,9.1,10.12,11.14,12.16],labels:["1/1","201/100","151/50","403/100","126/25","121/20","353/50","202/25","91/10","253/25","557/50","304/25"],labelPrecision:2},{name:"3. Inharmonic Membrane / Plate Modes (Bessel-root based)",description:'Modal ratios derived from the first zeros of Bessel-type modal functions \u2014 a physically informed inharmonic series used to synthesize metallic / bell / plate timbres. This is a simplified circular-membrane / plate approximation (modal zeros of Bessel functions scale the modal frequencies). For background, see the math of Bessel roots and plate/modal modeling: <a href="https://en.wikipedia.org/wiki/Bessel_function">Bessel functions</a> and a modal-plate overview: <a href="https://courses.cs.washington.edu/courses/cse481i/20wi/pdfs/G-waveguides.pdf">modal plate notes (UW)</a>.',ratios:[1,2.295417267427694,3.5984846739581138,4.903280573212368,6.208732130572546,7.514500962483965,8.820447105611922,10.126502295693772,11.432629299891351,12.738806093605008,14.04501881871901,15.351258321221767],labels:["1","5.52/2.40","8.65/2.40","11.79/2.40","14.93/2.40","18.07/2.40","21.21/2.40","24.35/2.40","27.49/2.40","30.63/2.40","33.78/2.40","36.92/2.40"],labelPrecision:3},{name:"4. Gamelan Slendro (Common Approximation)",description:'A conservative Slendro approximation \u2014 Slendro tunings vary widely between ensembles and islands. This is a plausible normalized Slendro-like series (useful as a starting point). See tuning variability and research: <a href="https://eamusic.dartmouth.edu/~larry/misc_writings/out_of_print/slendro_balungan.pdf">Javanese Slendro analyses</a> and a detailed study: <a href="https://www.31edo.com/slendrogamelan.pdf">Stearns \u2014 Slendro analysis</a>.',ratios:[1,1.22,1.48,1.76,2.05,2.44,2.96,3.52,4.1,4.88,5.92,7.04],labels:["1/1","61/50","37/25","44/25","41/20","61/25","74/25","88/25","41/10","122/25","148/25","176/25"],labelPrecision:2},{name:"4b. Slendro \u2014 Adventurous Variant (Exploratory)",description:"A more adventurous Slendro-inspired variant that shifts a few degrees towards septimal/7-limit alignments (useful for exotic spectral palettes). This is deliberately non-standard; treat it as a creative tuning palette rather than an ethnographic map.",ratios:[1,1.1428571428571428,1.4,1.7142857142857142,1.8,2.2857142857142856,2.625,3.5,4.5,5.5,6.5,7.5],labels:["1/1","8/7","7/5","12/7","9/5","16/7","21/8","7/2","9/2","11/2","13/2","15/2"],labelPrecision:3},{name:"5. Gamelan Pelog (Common Approximation)",description:'A conservative Pelog approximation (Pelog also varies a lot by ensemble). This is a practical Pelog-like set for synthesis; it compresses Pelog\u2019s characteristic unequal steps into a usable spectral array. See overview and sample tunings: <a href="https://tuning.ableton.com/sundanese-gamelan/">Ableton \u2014 Gamelan tuning intro</a>.',ratios:[1,1.06,1.25,1.3333333333333333,1.5,1.66,1.78,2,2.12,2.5,2.66,3],labels:["1/1","53/50","5/4","4/3","3/2","83/50","89/50","2/1","53/25","5/2","133/50","3/1"],labelPrecision:2},{name:"5b. Pelog \u2014 Adventurous Variant (Exploratory)",description:"A more adventurous Pelog variant that includes stronger septimal and odd-limit colors \u2014 useful when you want Pelog-ish contours but with richer microtonal tension.",ratios:[1,1.0416666666666667,1.125,1.2,1.1666666666666667,1.375,1.2857142857142858,1.5,1.75,1.6,1.8,2],labels:["1/1","25/24","9/8","6/5","7/6","11/8","9/7","3/2","7/4","8/5","9/5","2/1"],labelPrecision:3},{name:"6. Bohlen\u2013Pierce (13-EDT of the Tritave)",description:'Equal-tempered Bohlen\u2013Pierce: 13 equal divisions of the tritave (3:1) \u2014 the most common practical realization of BP. Each step = 3^(1/13) above the previous. Useful when you want the distinctive BP non-octave (tritave) periodicity. See the Bohlen\u2013Pierce overview: <a href="https://en.wikipedia.org/wiki/Bohlen%E2%80%93Pierce_scale">Bohlen\u2013Pierce (Wikipedia)</a>.',ratios:[1,Math.pow(3,.07692307692307693),Math.pow(3,.15384615384615385),Math.pow(3,.23076923076923078),Math.pow(3,.3076923076923077),Math.pow(3,.38461538461538464),Math.pow(3,.46153846153846156),Math.pow(3,.5384615384615384),Math.pow(3,.6153846153846154),Math.pow(3,.6923076923076923),Math.pow(3,.7692307692307693),Math.pow(3,.8461538461538461),Math.pow(3,.9230769230769231)],labels:["1/1","3^(1/13)","3^(2/13)","3^(3/13)","3^(4/13)","3^(5/13)","3^(6/13)","3^(7/13)","3^(8/13)","3^(9/13)","3^(10/13)","3^(11/13)"],labelPrecision:4},{name:"6b. Bohlen\u2013Pierce (Representative Just Intonation set)",description:'A commonly-cited Bohlen\u2013Pierce just-intonation palette assembled from small-ratio JI intervals historically associated with BP discussions (normalized to 1). This is an illustrative JI BP set \u2014 there are multiple JI realizations in the literature. See the JI vs. ET BP table: <a href="https://en.wikipedia.org/wiki/Bohlen%E2%80%93Pierce_scale#Intervals_and_scale_diagrams">BP intervals (Wikipedia)</a>.',ratios:[1,1.08,1.1904761904761905,1.2857142857142858,1.4,1.530612244897959,1.6666666666666667,1.8,1.96,2.142857142857143,2.3333333333333335,2.52],labels:["1/1","27/25","25/21","9/7","7/5","75/49","5/3","9/5","49/25","15/7","7/3","63/25"],labelPrecision:3},{name:"7. Standardized Lydian Root Set (Just-intonation oriented)",description:'A compact, standardized Lydian root set expressed in just-intonation ratios. This keeps the Lydian #4 character while using small-integer ratios for musical stability \u2014 useful when you want a Lydian-centered just palette (informed by George Russell\u02BCs idea of the Lydian center; see the Lydian Chromatic Concept: <a href="https://georgerussell.com/lydian-chromatic-concept">George Russell \u2014 Lydian Chromatic Concept</a>).',ratios:[1,1.125,1.25,1.40625,1.5,1.6,1.875,2,2.25,2.5,3.75,4],labels:["1/1","9/8","5/4","45/32","3/2","8/5","15/8","2/1","9/4","5/2","15/4","4/1"],labelPrecision:3},{name:"8. Fractional Series (n/4 Multiples)",description:"A deliberately inharmonic fractional series using n/4 multipliers (1, 1.25, 1.5, ...). Very metallic and clanging \u2014 excellent for bell-like additive synthesis with strong inharmonic beating.",ratios:[1,1.25,1.5,1.75,2,2.25,2.5,2.75,3,3.25,3.5,3.75],labels:["1/1","5/4","3/2","7/4","2/1","9/4","5/2","11/4","3/1","13/4","7/2","15/4"],labelPrecision:2},{name:"HP-A. Harry Partch \u2014 43-Tone Scale (overview subset)",description:`Harry Partch\u02BCs 43-tone scale (per octave) is a systematic 11-limit-based just-intonation framework Partch used for much of his instrument design and composition. This entry provides a practical 12-value subset sampled from Partch's larger lattice. See: <a href="https://en.wikipedia.org/wiki/Harry_Partch%27s_43-tone_scale">Harry Partch\u02BCs 43-tone scale (Wikipedia)</a>.`,ratios:[1,1.0909090909090908,1.1,1.1111111111111112,1.125,1.1428571428571428,1.1666666666666667,1.2,1.2222222222222223,1.25,1.2727272727272727,1.2857142857142858],labels:["1/1","12/11","11/10","10/9","9/8","8/7","7/6","6/5","11/9","5/4","14/11","9/7"],labelPrecision:4},{name:"HP-B. Harry Partch \u2014 11-Limit Tonality Diamond (subset)",description:'A focused 11-limit tonality diamond subset (useful Partchian palette). This selection expresses Partch\u02BCs hierarchy of consonance-to-dissonance in small integer ratios; use as a microtonal palette or for Partch-inspired composition. Reference: <a href="https://en.wikipedia.org/wiki/Harry_Partch%27s_43-tone_scale">Partch \u2014 43-tone & 11-limit ideas</a>.',ratios:[1,1.0666666666666667,1.125,1.2,1.25,1.3333333333333333,1.4,1.5,1.6,1.6666666666666667,1.8,2],labels:["1/1","16/15","9/8","6/5","5/4","4/3","7/5","3/2","8/5","5/3","9/5","2/1"],labelPrecision:4},{name:"HP-C. Harry Partch \u2014 Practical Instrument Subset (for keyboard/percussion)",description:"A small practical subset inspired by the subsets Partch used on instruments (Chromelodeon, Adapted Guitar, etc.) \u2014 chosen for playability while retaining Partch's just-intonation character. See Partch instrument descriptions: <a href='https://en.wikipedia.org/wiki/Harry_Partch%27s_43-tone_scale'>Partch overview</a>.",ratios:[1,1.125,1.2,1.25,1.3333333333333333,1.5,1.6,1.6666666666666667,1.8,1.875,2,2.25],labels:["1/1","9/8","6/5","5/4","4/3","3/2","8/5","5/3","9/5","15/8","2/1","9/4"],labelPrecision:4},{name:"OD-1. Hammond \u2014 Standard 9-drawbar (Manual) (Drawbars / Stops)",description:"Canonical Hammond single-manual drawbar mapping (left\u2192right): 16', 5 1/3', 8', 4', 2 2/3', 2', 1 3/5', 1 1/3', 1' \u2014 each represents a harmonic/aliquot of the fundamental. These are the classic additive palette used on B-3 / tonewheel organs. See Hammond drawbar docs for details.",ratios:[.5,1.5,1,2,3,4,5,6,8],labels:["1/2","3/2","1/1","2/1","3/1","4/1","5/1","6/1","8/1"],labelPrecision:3,notes:"Hammond drawbars intentionally sample selected harmonics (sub-octave through high partials); the 7th harmonic is omitted in the classic tonewheel mapping."},{name:"OD-1b. Hammond \u2014 Archaic / Mechanical Variant (Detuned Drawbars)",description:"Same drawbar targets as the standard Hammond set, but each partial includes a small progressive detune to model mechanical imperfections and tonewheel wear \u2014 useful to emulate slow beating and organic instability.",ratios:[.5,1.5011999999999999,1.0003,2.0012,2.9979,4.004,5.0075,5.997,8.016],labels:["1/2*1.00","3/2*1.00","1/1*1.00","2/1*1.00","3/1*0.99","4/1*1.00","5/1*1.00","6/1*1.00","8/1*1.00"],labelPrecision:5,notes:"Detune multipliers expressed as small fractional offsets (e.g. 8/10000 \u2248 0.8\u2030). These are artistic suggestions \u2014 increase offsets for stronger beating."},{name:"OD-2. Pipe Organ \u2014 Principal / Foundation Chorus (Stops)",description:"Common principal stops (footages) used in organ choruses: 16', 8', 4', 2', 1' \u2014 octave-power ranks; each rank doubles/halves frequency by powers of two. Good base palette for a church/archaic organ sound.",ratios:[.5,1,2,4,8],labels:["1/2","1/1","2/1","4/1","8/1"],labelPrecision:3,notes:"These are octave-related ranks (powers of two). Combine with mixture/mutation stops to build classic organ choruses."},{name:"OD-3. Baroque Cornet / Mixture \u2014 Mutation (Aliquot) Stops",description:"Typical cornet/mixture elements: mutation stops that speak at non-octave partials (3rd, 5th, 6th, etc.). Mutations color the principal chorus and are essential to many historical organ timbres.",ratios:[3,5,6,3,8],labels:["3/1 Naz","5/1 Tie","6/1 Lar","3/1 Naz","8/1 Mix"],labelPrecision:3,notes:"Mixtures vary by builder; the labels give common mutation names (Nazard, Tierce, Larigot). Mix design determines exact harmonic set."}],Ne=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],bt=130.81,yt=48,At=3,bn=48,Ge=4096,xt=12,St=.3,Et=.01,yn=12,Ve={RADIAL:.75,OSCILLOSCOPE:.25},qe=["#10b981","#fcd34d","#3b82f6","#ef4444","#a855f7","#f97316","#22c55e","#ec4899","#84cc16","#eab308","#7c3aed","#6d28d9"],He=["white","brown","white","white","brown","black","brown","white","black","blue","red","black","white","brown","black","blue"],i={audioRoutingMode:"mono",masterGainValue:St,masterSlewValue:Et,fundamentalFrequency:bt,currentMidiNote:yt,currentOctave:At,isPlaying:!1,currentSystem:R[0],harmonicAmplitudes:(()=>{let n=Array(xt).fill(0);return n[0]=1,n})(),isSubharmonic:!1,currentWaveform:"sine",visualizationFrequency:5.25,spreadFactor:.2,customWaveCount:0,audioContext:null,compressor:null,masterGain:null,oscillators:[],blWaveforms:{},p5Instance:null}});var Ue,T,ne=f(()=>{Ue=class{constructor(){this.params=new Map,this.isRunning=!1,this.frame=null,this.dt=1/60}debounce(e,t,r){this._debouncers||(this._debouncers=new Map),this._debouncers.has(e)&&clearTimeout(this._debouncers.get(e));let o=setTimeout(()=>{this._debouncers.delete(e),r()},t);this._debouncers.set(e,o)}smoothTo(e,t,r,o=.75){let a=this.params.get(e);a?(a.pendingTarget=t,a.smoothness=Math.min(Math.max(o,.01),.99999),a.active=!0):(a={current:t,target:t,pendingTarget:null,callback:r,smoothness:Math.min(Math.max(o,.01),.99999),active:!0},this.params.set(e,a)),this.isRunning||this.start()}setImmediate(e,t){let r=this.params.get(e);r&&(r.current=t,r.target=t,r.pendingTarget=null,r.active=!1,r.callback(t))}start(){this.isRunning||(this.isRunning=!0,this.tick())}tick(){let e=0;for(let[t,r]of this.params){if(r.pendingTarget!==null&&(r.target=r.pendingTarget,r.pendingTarget=null),!r.active)continue;let o=r.target-r.current;if(Math.abs(o)<1e-5){r.current=r.target,r.callback(r.current),r.active=!1;continue}let a=r.smoothness,s=Math.pow(a,this.dt*60);r.current=r.current*s+r.target*(1-s),r.callback(r.current),e++}e>0?this.frame=requestAnimationFrame(()=>this.tick()):(this.isRunning=!1,this.frame=null)}remove(e){this.params.delete(e)}clear(){this.params.clear(),this.frame&&cancelAnimationFrame(this.frame),this.isRunning=!1,this.frame=null}getCurrentValue(e){let t=this.params.get(e);return t?t.current:null}},T=new Ue});function re(n){let e=document.getElementById(n);return e||console.warn(`Element with id '${n}' not found`),e}function ze(n,e,t=!1){let r=re(n);r&&(t?r.innerHTML=e:r.textContent=e)}function $e(n,e){let t=re(n);t&&(t.value=e)}function oe(n,e,t){let r=re(n);r&&r.addEventListener(e,t)}function w(n,e="info"){let t=re("status-message");t&&(t.textContent=n,t.classList.remove("hidden","error","success","warning","info"),t.classList.add(e),setTimeout(()=>{t.classList.add("hidden")},4e3))}var N=f(()=>{});var x,L=f(()=>{x=class{constructor(e){if(typeof e=="string"?(this.el=document.querySelector(e),this.selector=e):this.el=e,!this.el)throw new Error(`BaseComponent: Target element "${e}" not found.`);this._boundEvents=[]}bindEvent(e,t,r){e&&(e.addEventListener(t,r),this._boundEvents.push({el:e,evt:t,handler:r}))}unbindAll(){for(let{el:e,evt:t,handler:r}of this._boundEvents)e.removeEventListener(t,r);this._boundEvents.length=0}teardown(){this.unbindAll()}updateContent(e,t="",{asHTML:r=!1}={}){e&&(r?e.innerHTML=t:e.textContent=t)}render(e){throw new Error("render() must be implemented in subclass")}q(e){return this.el.querySelector(e)}qAll(e){return Array.from(this.el.querySelectorAll(e))}}});var Mn,ae,Mt=f(()=>{A();L();Mn=".drawbar-slider",ae=class extends x{constructor(e){super(e),this.sliders=[]}render(e={}){this.el.innerHTML="",this.sliders=[],this.setupDrawbars(),this.updateDrawbarLabels(e.isSubharmonic)}bindRenderedEvents(){this.sliders=this.qAll(Mn),this.sliders.forEach(e=>{this.bindEvent(e,"input",t=>this.handleDrawbarChange(t))})}setupDrawbars(){let e=i.currentSystem.ratios.length;(!Array.isArray(i.harmonicAmplitudes)||i.harmonicAmplitudes.length!==e)&&(i.harmonicAmplitudes=Array(e).fill(0),i.harmonicAmplitudes[0]=1);for(let t=0;t<e;t++){let r=i.harmonicAmplitudes[t];this.el.appendChild(this.createDrawbar(t,r))}}updateDrawbarLabels(e){(e&&i.currentSystem.subharmonicLabels?i.currentSystem.subharmonicLabels:i.currentSystem.labels).forEach((r,o)=>{let a=this.q(`#drawbar-label-${o}`);this.updateContent(a,r)})}createDrawbar(e,t){let r=He[e]||"white",o=document.createElement("div");o.className=`drawbar ${r}`;let a=document.createElement("span");a.className="drawbar-label",a.id=`drawbar-label-${e}`,this.updateContent(a,i.currentSystem.labels[e]||"");let s=document.createElement("div");s.className="drawbar-track";let c=document.createElement("input");c.type="range",c.className="drawbar-slider",c.min="0",c.max="1",c.step="0.01",c.value=t,c.dataset.index=e;let l=document.createElement("div");return l.className="drawbar-input-wrapper",l.append(s,c),o.append(a,l),o}updateSingleDrawbar(e,t){this.sliders[e]&&(this.sliders[e].value=t)}handleDrawbarChange(e){let t=Number(e.target.dataset.index),r=Number(e.target.value);this.onChange?.(t,r),e.target.setAttribute("aria-valuenow",r)}setValue(e,t){this.sliders[e]&&(this.sliders[e].value=t)}}});var G,Ke=f(()=>{G=class{static transform(e,t=128){let r=e.length,o=Math.min(t,Math.floor(r/2)),a=new Float32Array(o+1).fill(0),s=new Float32Array(o+1).fill(0);a[0]=0;for(let c=1;c<=o;c++){let l=0,u=0;for(let d=0;d<r;d++){let m=2*Math.PI*c*d/r;l+=e[d]*Math.cos(m),u-=e[d]*Math.sin(m)}a[c]=2*l/r,s[c]=2*u/r}return{real:a,imag:s}}static inverseTransform(e,t,r=512){let o=new Float32Array(r);for(let a=0;a<r;a++){let s=a/r*2*Math.PI,c=0;for(let l=1;l<e.length&&l<t.length;l++)c+=e[l]*Math.cos(l*s)+t[l]*Math.sin(l*s);o[a]=c}return o}static getMagnitudeSpectrum(e,t){let r=new Float32Array(Math.min(e.length,t.length));for(let o=0;o<r.length;o++)r[o]=Math.sqrt(e[o]*e[o]+t[o]*t[o]);return r}static getPhaseSpectrum(e,t){let r=new Float32Array(Math.min(e.length,t.length));for(let o=0;o<r.length;o++)r[o]=Math.atan2(t[o],e[o]);return r}}});var P,ie=f(()=>{P=class n{static createBandLimitedWaveform(e,t,r=1024){let o=new Float32Array(r+1),a=new Float32Array(r+1),s=n.getFourierCoefficients(t,r);for(let c=1;c<=r;c++)a[c]=s[c]||0;return e.createPeriodicWave(o,a,{disableNormalization:!1})}static getFourierCoefficients(e,t){let r=new Array(t+1).fill(0);for(let o=1;o<=t;o++){let a=0,s=1;switch(e){case"square":o%2!==0&&(a=4/(Math.PI*o));break;case"sawtooth":a=2/(Math.PI*o),s=o%2===0?-1:1;break;case"triangle":o%2!==0&&(a=8/(Math.PI*Math.PI*o*o),s=(o-1)/2%2===0?1:-1);break;default:throw new Error(`Unsupported waveform type: ${e}`)}r[o]=a*s}return r}static generateTimeDomainSamples(e,t=1024,r=64){let o=new Float32Array(t),a=n.getFourierCoefficients(e,r);for(let s=0;s<t;s++){let c=s/t*2*Math.PI,l=0;for(let u=1;u<=r;u++)a[u]!==0&&(l+=a[u]*Math.sin(u*c));o[s]=l*.7}return o}static createCustomWaveform(e,t,r){return e.createPeriodicWave(t,r,{disableNormalization:!1})}}});var j,Tt=f(()=>{j=class n{static exportAsWAV(e,t,r,o=1){if(!Array.isArray(e)||e.length===0)throw new Error("WAV export failed: expected an array of channel buffers.");let a=e.length,s=e[0].length;for(let u=0;u<a;u++){if(!(e[u]instanceof Float32Array))throw new Error(`Channel ${u} is not a Float32Array.`);if(e[u].length!==s)throw new Error(`Channel ${u} length mismatch.`)}let c=e.map(u=>n.repeatBuffer(u,o)),l=n.createWAVBufferMulti(c,t);n.downloadFile(l,r)}static repeatBuffer(e,t){let r=e.length,o=r*t,a=new Float32Array(o);for(let s=0;s<o;s++)a[s]=e[s%r];return a}static createWAVBufferMulti(e,t){let r=e.length,o=e[0].length,a=2,s=r*a,c=t*s,l=o*s,u=new ArrayBuffer(44+l),d=new DataView(u),m=0;n.writeString(d,m,"RIFF"),m+=4,d.setUint32(m,36+l,!0),m+=4,n.writeString(d,m,"WAVE"),m+=4,n.writeString(d,m,"fmt "),m+=4,d.setUint32(m,16,!0),m+=4,d.setUint16(m,1,!0),m+=2,d.setUint16(m,r,!0),m+=2,d.setUint32(m,t,!0),m+=4,d.setUint32(m,c,!0),m+=4,d.setUint16(m,s,!0),m+=2,d.setUint16(m,a*8,!0),m+=2,n.writeString(d,m,"data"),m+=4,d.setUint32(m,l,!0),m+=4;for(let h=0;h<o;h++)for(let p=0;p<r;p++){let g=Math.max(-1,Math.min(1,e[p][h]));d.setInt16(m,g*32767,!0),m+=2}return u}static writeString(e,t,r){for(let o=0;o<r.length;o++)e.setUint8(t+o,r.charCodeAt(o))}static downloadFile(e,t){let r=new Blob([e],{type:"audio/wav"}),o=URL.createObjectURL(r),a=document.createElement("a");a.href=o,a.download=t,a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(()=>URL.revokeObjectURL(o),100)}}});var Y,Pt=f(()=>{Ke();ie();Y=class{constructor(){this.waveforms=new Map,this.coefficients=new Map,this.periodMultipliers=new Map,this.count=0}addFromSamples(e,t,r=128,o=1){if(e.length===0)throw new Error("Cannot add empty waveform data.");let a=0;for(let m=0;m<e.length;m++)Math.abs(e[m])>a&&(a=Math.abs(e[m]));let s=e;if(a>0&&a!==1){s=new Float32Array(e.length);for(let m=0;m<e.length;m++)s[m]=e[m]/a}let{real:c,imag:l}=G.transform(s,r),u=P.createCustomWaveform(t,c,l);this.count++;let d=`custom_${Date.now()}_${this.count}`;return this.waveforms.set(d,u),this.coefficients.set(d,{real:c,imag:l}),this.periodMultipliers.set(d,o),d}addFromCoefficients(e,t,r){let o=P.createCustomWaveform(r,e,t);this.count++;let a=`custom_${this.count}`;return this.waveforms.set(a,o),this.coefficients.set(a,{real:new Float32Array(e),imag:new Float32Array(t)}),a}getWaveform(e){return this.waveforms.get(e)||null}getCoefficients(e){return this.coefficients.get(e)||null}getPeriodMultiplier(e){return this.periodMultipliers.get(e)||1}reconstructSamples(e,t=512){let r=this.coefficients.get(e);return r?G.inverseTransform(r.real,r.imag,t):null}getAllKeys(){return Array.from(this.waveforms.keys())}remove(e){let t=this.waveforms.delete(e),r=this.coefficients.delete(e);return t&&r}clear(){this.waveforms.clear(),this.coefficients.clear(),this.count=0}getCount(){return this.waveforms.size}exportData(e){let t=this.coefficients.get(e);return t?{key:e,real:Array.from(t.real),imag:Array.from(t.imag),timestamp:Date.now()}:null}importData(e,t){let r=new Float32Array(e.real),o=new Float32Array(e.imag);return this.addFromCoefficients(r,o,t)}}});var Z,It=f(()=>{ie();Z=class{constructor(){this.context=null,this.masterGain=null,this.compressor=null,this.oscillators=new Map,this.isInitialized=!1,this.standardWaveforms=new Map}async initialize(e=.5){this.isInitialized||(this.context=new(window.AudioContext||window.webkitAudioContext),this.setupAudioGraph(e),this.generateStandardWaveforms(),this.isInitialized=!0,this.context.state==="suspended"&&await this.context.resume())}async resume(){this.context&&this.context.state==="suspended"&&await this.context.resume()}setupAudioGraph(e){this.compressor=this.context.createDynamicsCompressor(),this.compressor.threshold.setValueAtTime(-24,this.context.currentTime),this.compressor.ratio.setValueAtTime(6,this.context.currentTime),this.compressor.attack.setValueAtTime(.01,this.context.currentTime),this.compressor.release.setValueAtTime(.2,this.context.currentTime),this.masterGain=this.context.createGain(),this.masterGain.gain.setValueAtTime(e,this.context.currentTime),this.masterGain.maxGain=1,this.limiter=this.context.createDynamicsCompressor(),this.limiter.threshold.setValueAtTime(-6,this.context.currentTime),this.limiter.ratio.setValueAtTime(6,this.context.currentTime),this.limiter.attack.setValueAtTime(.005,this.context.currentTime),this.limiter.release.setValueAtTime(.15,this.context.currentTime),this.compressor.connect(this.masterGain),this.masterGain.connect(this.limiter),this.limiter.connect(this.context.destination)}generateStandardWaveforms(){let e=["square","sawtooth","triangle"];for(let t of e){let r=P.createBandLimitedWaveform(this.context,t,128);this.standardWaveforms.set(t,r)}}getStandardWaveform(e){return this.standardWaveforms.get(e)||null}createOscillator(e,t,r=1,o={}){if(!this.isInitialized)throw new Error("AudioEngine must be initialized before creating oscillators");let a=this.context.createOscillator(),s=this.context.createGain();if(a.frequency.setValueAtTime(e,this.context.currentTime),typeof t=="string")if(t==="sine")a.type="sine";else if(this.standardWaveforms.has(t))a.setPeriodicWave(this.standardWaveforms.get(t));else throw new Error(`Unknown waveform type: ${t}`);else if(t instanceof PeriodicWave)a.setPeriodicWave(t);else throw new Error("Waveform must be a string or PeriodicWave");s.gain.setValueAtTime(r,this.context.currentTime);let c=this.context.createStereoPanner();return c.pan.setValueAtTime(o.pan??0,this.context.currentTime),a.connect(s),s.connect(c),c.connect(this.compressor),{oscillator:a,gainNode:s,panner:c}}addOscillator(e,t){t.oscillator.start(this.context.currentTime),this.oscillators.set(e,t)}updateOscillatorFrequency(e,t,r=.02){let o=this.oscillators.get(e);if(o&&o.oscillator){let a=this.context.currentTime;o.oscillator.frequency.setTargetAtTime(t,a,r/3)}}updateOscillatorGain(e,t,r=.02){let o=this.oscillators.get(e);if(o&&o.gainNode){let a=this.context.currentTime;o.gainNode.gain.setTargetAtTime(t,a,r/3)}}updateMasterGain(e,t=.02){if(this.masterGain){let r=this.context.currentTime;this.masterGain.gain.setTargetAtTime(e,r,t/3)}}stopAllOscillators(){let e=this.context.currentTime;for(let t of this.oscillators.values())if(t.oscillator)try{t.oscillator.stop(e+.01)}catch{}this.oscillators.clear()}getContext(){return this.context}}});var Wt=f(()=>{Ke();ie();Tt();Pt();It()});var et={};Oe(et,{addWaveformToAudio:()=>Je,exportAsWAV:()=>Ze,getAudioEngine:()=>Ye,getWaveValue:()=>Ft,getWavetableManager:()=>se,initAudio:()=>ce,precomputeWaveTable:()=>Xe,precomputeWavetableFromCoefficients:()=>Qe,restartAudio:()=>me,sampleCurrentWaveform:()=>V,setDownloadRoutingMode:()=>Tn,startTone:()=>le,stopTone:()=>ue,updateAudioProperties:()=>I});function Tn(n){i.downloadRoutingMode=n}function Ye(){return b}function se(){return J}async function ce(){b||(b=new Z,J=new Y,await b.initialize(i.masterGainValue),i.audioContext=b.getContext(),i.compressor=b.compressor,i.masterGain=b.masterGain,i.blWaveforms=i.blWaveforms||{},i.blWaveforms.square=b.getStandardWaveform("square"),i.blWaveforms.sawtooth=b.getStandardWaveform("sawtooth"),i.blWaveforms.triangle=b.getStandardWaveform("triangle")),await b.resume()}function Pn(n){return n?n.startsWith("custom_")?J.getWaveform(n)||"sine":n:"sine"}function Dt(n){if(!n||!n.startsWith("custom_"))return 1;let e=1;return J?e=J.getPeriodMultiplier(n):i.customWavePeriodMultipliers&&(e=i.customWavePeriodMultipliers[n]||1),1/e}async function le(){if(await ce(),!i.isPlaying)try{await In(),v({isPlaying:!0})}catch(n){throw console.error("Failed to start synthesis:",n),n}}async function In(){i.oscillators=[];let n=i.oscillatorPans||[],e=i.currentSystem.ratios.length;for(let t=0;t<i.harmonicAmplitudes.length;t++)if(t<e){let r=i.currentSystem.ratios[t],o=i.harmonicAmplitudes[t]||0;if(r>0){let a=tt(r),s=o*i.masterGainValue,c=Pn(i.currentWaveform),l=Dt(i.currentWaveform),u=a*l,m={pan:t===0?0:n[t]??(t%2===0?-.8:.8)};try{let h=b.createOscillator(u,c,s,m),p=`harmonic_${t}`;for(b.addOscillator(p,h);i.oscillators.length<=t;)i.oscillators.push(null);i.oscillators[t]={key:p,ratio:r}}catch(h){console.error(`Failed to create oscillator ${t}:`,h),i.oscillators[t]=null}}else i.oscillators[t]=null}else i.harmonicAmplitudes[t]=0,i.oscillators[t]=null}function ue(){!i.isPlaying||!b||(b.stopAllOscillators(),v({oscillators:[],isPlaying:!1}))}function I(){if(!i.isPlaying||!b)return;let n=i.masterSlewValue;Wn(n)}function Wn(n){b.updateMasterGain(i.masterGainValue,n),i.oscillators.forEach((e,t)=>{if(e&&e.key){let r=i.currentSystem.ratios[t],o=tt(r),a=Dt(i.currentWaveform),s=o*a,l=(i.harmonicAmplitudes[t]||0)*i.masterGainValue;!isFinite(s)||isNaN(s)?l=0:b.updateOscillatorFrequency(e.key,s,n),b.updateOscillatorGain(e.key,l,n)}})}function me(){i.isPlaying&&(ue(),setTimeout(le,50))}async function V(n="mono",e=!1){await ce();let t=i.harmonicAmplitudes.length,r=Ge;if(!i.currentSystem||!i.currentSystem.ratios)return console.error("Spectral system missing"),{buffer:new Float32Array(0),periodMultiplier:1};let o=[];for(let u=0;u<t;u++)i.harmonicAmplitudes[u]>.001&&o.push(i.currentSystem.ratios[u]);let a=Dn(o,e),s=2*Math.PI*a,c=i.customWaveCoefficients?.[i.currentWaveform],l=Array(t).fill(null).map(()=>new Float32Array(r));for(let u=0;u<t;u++){let d=i.harmonicAmplitudes[u];if(d<=.001)continue;let m=i.currentSystem.ratios[u],h=l[u];for(let g=0;g<r;g++){let y=g/(r-1)*s,B=e?1/m*y:m*y;h[g]=Ft(i.currentWaveform,B,c)*d}let p=0;for(let g=0;g<r;g++)p=Math.max(p,Math.abs(h[g]));if(p>0){let g=1/p;for(let y=0;y<r;y++)h[y]*=g}}switch(n){case"mono":{let u=new Float32Array(r);for(let m=0;m<t;m++){let h=l[m];if(h)for(let p=0;p<r;p++)u[p]+=h[p]}let d=0;for(let m=0;m<r;m++)d=Math.max(d,Math.abs(u[m]));if(d>0){let m=1/d;for(let h=0;h<r;h++)u[h]*=m}return{buffer:u,periodMultiplier:a}}case"stereo":{let u=new Float32Array(r),d=new Float32Array(r);for(let h=0;h<t;h++){let p=l[h];if(!p)continue;let y=((i.oscillatorPans?.[h]??0)+1)*.5,B=Math.cos(y*Math.PI*.5),Be=Math.sin(y*Math.PI*.5);for(let C=0;C<r;C++){let O=p[C];u[C]+=O*B,d[C]+=O*Be}}let m=0;for(let h=0;h<r;h++)m=Math.max(m,Math.abs(u[h]),Math.abs(d[h]));if(m>0){let h=1/m;for(let p=0;p<r;p++)u[p]*=h,d[p]*=h}return{buffers:[u,d],periodMultiplier:a}}case"multichannel":{let d=[];for(let m=0;m<12;m++)d[m]=l[m]??new Float32Array(r);for(let m=0;m<12;m++){let h=d[m],p=0;for(let g=0;g<r;g++)p=Math.max(p,Math.abs(h[g]));if(p>0){let g=1/p;for(let y=0;y<r;y++)h[y]*=g}}return{buffers:d,periodMultiplier:a}}default:return console.warn(`Unknown routingMode ${n}, defaulting to mono`),V("mono",e)}}function Dn(n,e){if(n.length===0)return 1;let r=n.map(o=>{let a=1,s=1/0;for(let c=1;c<=20;c++){let l;e?l=1/o*c:l=o*c;let u=Math.abs(l-Math.round(l));if(u<s&&(s=u,a=c),u<.001)break}return console.log(`Ratio ${o}: best period ${a} gives ${o*a} cycles (error: ${s})`),a}).reduce((o,a)=>{let s=(c,l)=>l===0?c:s(l,c%l);return o*a/s(o,a)},1);return Math.min(r,20)}function Ze(n,e=1){if(!i.audioContext){w("Error: Audio system not initialized. Please click 'Start Tone' first.","error");return}if(!n){w("WAV Export Failed: No waveform data passed.","error");return}let t=n.periodMultiplier||1,r;if(n.buffers&&Array.isArray(n.buffers))r=n.buffers;else if(n.buffer)r=[n.buffer];else{w("WAV Export Failed: Invalid waveform data structure.","error");return}if(r.length===0||r[0].length===0){w("WAV Export Failed: Cannot export empty waveform data.","error");return}let a=i.audioContext.sampleRate/t;console.log(`WAV Export: channels=${r.length}, period multiplier=${t}, sampleRate=${a}`);let s=de(),c=[s.noteLetter,s.waveform,s.systemName,s.levels,s.subharmonicFlag].filter(Boolean).join("-")+".wav";try{j.exportAsWAV(r,a,c,e),w(`Wavetable exported as ${c} (${a}Hz)!`,"success")}catch(l){w(`WAV Export Failed: ${l.message}`,"error")}}function Ft(n,e,t){if(n.startsWith("custom")){let r=je[n];if(!r){if(!t)return Math.sin(e);r=je[n]=Qe(t,512)}let a=e%(2*Math.PI)/(2*Math.PI)*(r.length-1),s=a|0,c=(s+1)%r.length,l=a-s;return r[s]*(1-l)+r[c]*l}switch(n){case"sine":return Math.sin(e);case"square":{let r=0,o=16;for(let a=1;a<o*2;a+=2)r+=1/a*Math.sin(e*a);return r*(4/Math.PI)*.7}case"sawtooth":{let r=0,o=16;for(let a=1;a<=o;a++)r+=1/a*Math.sin(e*a);return r*(2/Math.PI)*.7}case"triangle":{let r=0,o=16;for(let a=1;a<o*2;a+=2){let s=(a-1)/2%2===0?1:-1;r+=s/(a*a)*Math.sin(e*a)}return r*(8/(Math.PI*Math.PI))*.7}default:return Math.sin(e)}}async function Je(n,e,t){await ce();let r=se().addFromSamples(n,t.audioContext,128,e),o=se().getCoefficients(r);je[r]=Qe(o);let a=se().getWaveform(r);return{waveKey:r,coefficients:o,periodicWave:a}}function Xe(n,e=512){let t=new Float32Array(e);if(n instanceof Float32Array){let r=n,o=(r.length-1)/(e-1);for(let a=0;a<e;a++){let s=a*o,c=Math.floor(s),l=Math.min(c+1,r.length-1),u=s-c;t[a]=r[c]*(1-u)+r[l]*u}return t}if(n.real&&n.imag){let r=n.real,o=n.imag,a=Math.min(r.length,o.length);for(let s=0;s<e;s++){let c=s/e*Math.PI*2,l=0;for(let u=1;u<a;u++)l+=r[u]*Math.cos(u*c)+o[u]*Math.sin(u*c);t[s]=l}return t}return console.error("precomputeUnifiedWaveTable: invalid input",n),new Float32Array(e)}function Qe(n,e=512){let t=new Float32Array(e),r=0;for(let o=0;o<e;o++){let a=o/e*2*Math.PI,s=0;for(let c=1;c<n.real.length&&c<n.imag.length;c++)s+=n.real[c]*Math.cos(c*a)+n.imag[c]*Math.sin(c*a);t[o]=s,Math.abs(s)>r&&(r=Math.abs(s))}if(r>0){let o=1/r;for(let a=0;a<e;a++)t[a]*=o}return t}var b,J,je,E=f(()=>{A();k();Wt();N();b=null,J=null;je={}});function Fn(n){let e=Math.floor(n/12)-1,t=n%12;return Ne[t]+e}function _n(n){return Math.round(n*15).toString(16).toUpperCase()}function Rn(){return i.harmonicAmplitudes.slice(0,12).map(_n).join("")}function de(){let n=Fn(i.currentMidiNote).replace("#","s"),e=i.currentWaveform.toUpperCase().replace("_","-"),t=i.currentSystem.name.split(".")[1].trim().replace(/[^a-zA-Z0-9_]/g,""),r=Rn(),o=i.isSubharmonic?"subharmonic":"";return{noteLetter:n,waveform:e,systemName:t,levels:r,subharmonicFlag:o}}function tt(n){return i.isSubharmonic?n===0?0:i.fundamentalFrequency/n:i.fundamentalFrequency*n}function he(n,e,t=!1){let r=`harmonic_${n}`;if(t){T.setImmediate(r,e),i.harmonicAmplitudes[n]=e,I();return}T.smoothTo(r,e,o=>{i.harmonicAmplitudes[n]=o,I()},.8)}function pe(n){T.smoothTo("master_gain",n,async e=>{i.masterGainValue=e;let{updateAudioProperties:t}=await Promise.resolve().then(()=>(E(),et));t()},.8)}function _t(n,e=null){nt=n,T.debounce("systemChange",35,async()=>{let t=nt;if(t===null)return;let{setCurrentSystem:r}=await Promise.resolve().then(()=>(A(),Ct)),{updateAudioProperties:o}=await Promise.resolve().then(()=>(E(),et));r(t),i.isPlaying&&o(),e&&e(),nt=null})}var nt,k=f(()=>{A();ne();ne();E();nt=null});var q,H,U,W,D,fe,F=f(()=>{q="drawbar-change",H="drawbars-randomized",U="drawbars-reset",W="spectral-system-changed",D="subharmonic-toggled",fe="routing-mode-changed"});var M,ge=f(()=>{A();k();F();M={setDrawbar(n,e){let t=i.harmonicAmplitudes;t&&t.length>n&&t[n]!==e&&(t[n]=e,v({harmonicAmplitudes:t}),he(n,e),document.dispatchEvent(new CustomEvent(q,{detail:{index:n,value:e}})))},randomize(){let n=i.harmonicAmplitudes.map((e,t)=>t===0?.5+Math.random()*.5:Math.random());v({harmonicAmplitudes:n}),n.forEach((e,t)=>{he(t,e)}),document.dispatchEvent(new Event(H))},reset(){let e=(i.harmonicAmplitudes||[]).map((t,r)=>r===0?1:0);v({harmonicAmplitudes:e}),e.forEach((t,r)=>{he(r,t,!0)}),document.dispatchEvent(new Event(U))}}});var S,z=f(()=>{S=class{constructor(e){if(typeof this.createComponent!="function")throw new Error("Subclass must implement createComponent(selector)");if(this.selector=e,this.component=this.createComponent(e),!this.component)throw new Error("createComponent() must return a component instance")}init(){this.bindComponentEvents(),this.bindExternalEvents(),this.update()}getProps(){throw new Error("Subclass must implement getProps()")}update(){let e=this.getProps();return this.component.teardown&&this.component.teardown(),this.component.render(e),typeof this.component.bindRenderedEvents=="function"&&this.component.bindRenderedEvents(),e}bindComponentEvents(){}bindExternalEvents(){}destroy(){this.component.teardown&&this.component.teardown()}}});var Ln,kn,we,Rt=f(()=>{Mt();ge();F();z();A();Ln="reset-drawbars-button",kn="randomize-drawbars-button",we=class extends S{createComponent(e){return new ae(e)}bindComponentEvents(){this.component.onChange=(e,t)=>{M.setDrawbar(e,t)}}updateDrawbar({index:e,value:t}){this.component.updateSingleDrawbar(e,t)}reset(){M.reset()}randomize(){M.randomize()}bindExternalEvents(){document.addEventListener(q,e=>this.updateDrawbar(e.detail)),document.addEventListener(H,()=>this.update()),document.addEventListener(U,()=>this.update()),document.addEventListener(W,()=>this.update()),document.addEventListener(D,()=>this.update()),document.getElementById(Ln)?.addEventListener("click",()=>{this.reset()}),document.getElementById(kn)?.addEventListener("click",()=>{this.randomize()})}getProps(){return{isSubharmonic:i.isSubharmonic}}}});var ve,Lt=f(()=>{E();A();F();k();ve={toggleSubharmonic(){let n=!i.isSubharmonic;v({isSubharmonic:n}),document.dispatchEvent(new CustomEvent(D,{detail:{isSubharmonic:n}}))},setSystem(n){v({currentSystem:R[n]});let e=i.currentSystem.ratios.length,t=i.harmonicAmplitudes||[],r=[];for(let o=0;o<e;o++)r[o]=typeof t[o]=="number"?t[o]:o===0?1:0;for(let o=t.length;o<e;o++)r[o]=o===0?1:0;i.harmonicAmplitudes=r,_t(n),document.dispatchEvent(new CustomEvent(W,{detail:{index:n,system:i.currentSystem}}))},updateAudio(){I()}}});var Bn,be,kt=f(()=>{L();Bn="#ratio-system-select",be=class extends x{constructor(t){super(t);vt(this,"_subharmonicToggleHandler",null);this.onChange=null,this.onSubharmonicToggle=null}render({systems:t,currentSystem:r,isSubharmonic:o}){let a=this.q("#ratio-system-select"),s=this.q("#system-description");if(a){for(;a.firstChild;)a.removeChild(a.firstChild);t.forEach((c,l)=>{let u=document.createElement("option");u.textContent=c.name,u.value=l,c===r&&(u.selected=!0),a.appendChild(u)}),this.updateContent(s,r?.description||"",{asHTML:!0}),this.renderSubharmonicToggle({isSubharmonic:o})}}updateSelector({currentSystem:t,systems:r}){let o=this.q("#ratio-system-select");if(!o)return;let a=r.findIndex(s=>s===t);a>=0&&(o.value=a)}bindComponentEvents(){let t=this.q(Bn);t&&(this._selectChangeHandler&&t.removeEventListener("change",this._selectChangeHandler),this._selectChangeHandler=r=>{let o=parseInt(r.target.value);console.log("[SpectralSystemComponent] Dropdown changed:",o),this.onChange?.(o),r.target.setAttribute("aria-valuenow",o)},t.addEventListener("change",this._selectChangeHandler))}renderSubharmonicToggle({isSubharmonic:t}){let r=this.q("#subharmonic-toggle");r&&(r.classList.toggle("active",t),r.setAttribute("aria-checked",t),this._subharmonicToggleHandler&&r.removeEventListener("click",this._subharmonicToggleHandler),this._subharmonicToggleHandler=o=>{this.onSubharmonicToggle?.()},r.addEventListener("click",this._subharmonicToggleHandler))}}});var ye,Bt=f(()=>{z();Lt();kt();A();F();ye=class extends S{init(){super.init(),this.component.bindComponentEvents()}update(){let e=super.update();this.component.updateSelector(e)}createComponent(e){return new be(e)}getProps(){return{systems:R,currentSystem:i.currentSystem,isSubharmonic:i.isSubharmonic}}bindComponentEvents(){this.component.onChange=e=>{ve.setSystem(e)},this.component.onSubharmonicToggle=()=>{ve.toggleSubharmonic()},typeof this.component.bindComponentEvents=="function"&&this.component.bindComponentEvents()}bindExternalEvents(){document.addEventListener(W,()=>{this.update()}),document.addEventListener(D,()=>{typeof this.component.renderSubharmonicToggle=="function"&&this.component.renderSubharmonicToggle({isSubharmonic:i.isSubharmonic}),this.update(),ve.updateAudio()})}}});function On(n,e){return n*e/Ot(n,e)}function Ot(n,e){return e===0?n:Ot(e,n%e)}function rt(n){return n.reduce((e,t)=>On(e,t),1)}function Nn(n){return function(e){n._waveformP5=e,e.setup=function(){let t=n.el,r=t?.clientWidth||400;e.createCanvas(r,150).parent(t),e.noLoop()},e.windowResized=function(){let r=n.el?.clientWidth||400;e.resizeCanvas(r,150),e.redraw()},e.draw=function(){let t=n.props;if(!t?.p5Instance||!t.harmonicAmplitudes?.length)return;let r=e.width,o=e.height,a=o*.4;if(e.background("#0d131f"),e.stroke("#374151"),e.strokeWeight(1),e.line(0,o/2,r,o/2),e.stroke("#10b981"),e.strokeWeight(2),e.noFill(),e.beginShape(),t.mode==="single")for(let s=0;s<r;s++){let c=e.map(s,0,r,0,e.TWO_PI*2),l=t.currentSystem.ratios[0],u=Ae(t.currentWaveform,l*c,t.customWaveCoefficients?.[t.currentWaveform]),d=o/2-u*a;e.vertex(s,d)}else{let s=2;if(t.isSubharmonic){let l=t.currentSystem.ratios.map((u,d)=>t.harmonicAmplitudes[d]>.001?Math.round(u):null).filter(Boolean);l.length>0&&(s=rt(l),s=Math.min(s,32))}let c=e.TWO_PI*s/r;for(let l=0;l<r;l++){let u=l*c,d=0,m=0;for(let p=0;p<t.harmonicAmplitudes.length;p++){let g=t.harmonicAmplitudes[p]||0;if(g>.001){let y=t.currentSystem.ratios[p],B=t.isSubharmonic?u/y:y*u;d+=Ae(t.currentWaveform,B,n.props.customWaveCoefficients?.[t.currentWaveform])*g,m+=g}}let h=o/2-d/(m||1)*a;e.vertex(l,h)}}e.endShape()}}}var X,ot=f(()=>{L();xe();X=class extends x{constructor(e){super(e),this._waveformP5=null,this.props={}}render(e){if(this.props=e,this.teardown(),!e.p5Instance){requestAnimationFrame(()=>this.render(e));return}let t=Nn(this);this._waveformP5=new p5(t,this.el)}teardown(){this._waveformP5?.remove&&(this._waveformP5.remove(),this._waveformP5=null),super.teardown?.()}}});function Gn(){return function(n){i.p5Instance=n,n.setSpreadFactor=function(a){at=a},n.getSpreadFactor=function(){return at},n.setup=function(){let a=document.getElementById("tonewheel-canvas"),s=a?a.clientWidth:800,c=s;s===0&&(s=window.innerWidth<640?320:800,c=s,console.warn("Canvas container width was 0, using fallback width:",s)),n.createCanvas(s,c).parent(a?"tonewheel-canvas":"body"),n.angleMode(n.RADIANS),e()};function e(){let a=n.height*Ve.RADIAL;it=n.min(n.width,a)*(1-Nt)*.45,Se=n.min(n.width,a)*Nt}n.updateDimensions=e,n.customWaveTables={},n.precomputeCustomWaveTable=function(a){let c=new Float32Array(512);for(let l=0;l<512;l++){let u=l/512*n.TWO_PI,d=0;for(let m=1;m<a.real.length&&m<a.imag.length;m++)d+=a.real[m]*n.cos(m*u)+a.imag[m]*n.sin(m*u);c[l]=d}return c},n.clearCustomWaveCache=function(){n.customWaveTables={}};function t({harmonicAmplitudes:a,baseRadius:s,maxLaneHeight:c}){let l=a.map((p,g)=>({amp:p,idx:g})).filter(p=>p.amp>0),u=l.length,d=new Array(a.length),m=c/u,h=s;for(let p=0;p<u;p++){let g=l[p].idx;d[g]=h,h+=m}return d}function r(){n.push(),n.translate(n.width/2,n.height/2),n.noFill(),n.stroke("#374151"),n.ellipse(0,0,Se*2,Se*2);let a=360,s=i.visualizationFrequency*n.TWO_PI/60,c=n.frameCount*s;o(a,c),n.pop()}function o(a,s){let c=i.currentWaveform,l=i.harmonicAmplitudes.length,u=t({harmonicAmplitudes:i.harmonicAmplitudes,baseRadius:Se,maxLaneHeight:it}),d=1;if(i.isSubharmonic){let h=i.currentSystem.ratios.map((p,g)=>i.harmonicAmplitudes[g]>.001?Math.round(p):null).filter(Boolean);h.length>0&&(d=rt(h),d=Math.min(d,32))}let m=n.TWO_PI*d/a;for(let h=0;h<l;h++){let p=i.harmonicAmplitudes[h];if(p<=.001)continue;let g=i.currentSystem.ratios[h],y=u[h],Be=.45*(it/l)*at*p;n.stroke(n.color(qe[h]+"99")),n.strokeWeight(2),n.noFill(),n.beginShape();for(let C=0;C<a;C++){let O=C*m,pn=i.isSubharmonic?O/g:O*g,fn=Ae(c,pn,i.customWaveCoefficients?.[c]),ft=O+s,gt=y+fn*Be,gn=gt*n.cos(ft),wn=gt*n.sin(ft);n.vertex(gn,wn)}n.endShape(n.CLOSE)}}n.draw=function(){n.clear(),n.background("#111827"),e(),r()},n.windowResized=function(){let a=document.getElementById("tonewheel-canvas"),s=a?a.clientWidth:800,c=s;s===0&&(s=window.innerWidth<640?320:800,c=s),n.resizeCanvas(s,c),e()}}}function Ae(n,e,t){if(n&&n.startsWith("custom")){let r=n;!st.has(r)&&t&&st.set(r,Xe(t,Vn));let o=st.get(r);if(!o)return Math.sin(e);let s=e%(2*Math.PI)/(2*Math.PI)*(o.length-1),c=Math.floor(s),l=Math.ceil(s),u=s-c;return c===l?o[c]:o[c]*(1-u)+o[l]*u}switch(n){case"sine":return Math.sin(e);case"square":{let r=0,o=16;for(let a=1;a<o*2;a+=2)r+=1/a*Math.sin(e*a);return r*(4/Math.PI)*.7}case"sawtooth":{let r=0,o=16;for(let a=1;a<=o;a++)r+=1/a*Math.sin(e*a);return r*(2/Math.PI)*.7}case"triangle":{let r=0,o=16;for(let a=1;a<o*2;a+=2){let s=(a-1)/2%2===0?1:-1;r+=s/(a*a)*Math.sin(e*a)}return r*(8/(Math.PI*Math.PI))*.7}default:return Math.sin(e)}}var at,Se,it,Nt,$,st,Vn,xe=f(()=>{A();E();ot();at=1,Nt=.08,$={initVisualization(){if(p5){let n=Gn();return new p5(n,"tonewheel-canvas")}return null},setVisualizationFrequency(n){v({visualizationFrequency:n})},setSpreadFactor(n){i.p5Instance&&i.p5Instance.setSpreadFactor&&i.p5Instance.setSpreadFactor(n)},getSpreadFactor(){return i.p5Instance&&i.p5Instance.getSpreadFactor?i.p5Instance.getSpreadFactor():.2},clearCustomWaveCache(){i.p5Instance&&i.p5Instance.clearCustomWaveCache&&i.p5Instance.clearCustomWaveCache()}};st=new Map,Vn=512});function Gt(n){let e=n.target.value;v({currentWaveform:e}),document.dispatchEvent(new CustomEvent(Ee,{detail:{currentWaveform:e}})),i.isPlaying&&me()}function Vt(n,e){V(n,e).then(t=>{(t.buffer||t).length>0&&qn(t)}).catch(t=>{console.error("Failed to sample waveform for adding:",t),w("Failed to sample waveform for adding","error")})}async function qn(n){let e=n.buffer||n,t=n.periodMultiplier||1;if(e.length===0){w("Warning: Cannot add empty waveform data.","warning");return}try{let{waveKey:r,coefficients:o,periodicWave:a}=await Je(e,t,i),s=Hn(i,r,o,a,t);Un(i,r,s),document.dispatchEvent(new CustomEvent(Ee))}catch(r){w(`Failed to add waveform: ${r.message}`,"error")}}function Hn(n,e,t,r,o){return n.blWaveforms[e]=r,n.customWaveCoefficients||(n.customWaveCoefficients={}),n.customWaveCoefficients[e]=t,n.customWaveCount=(n.customWaveCount||0)+1,n.customWavePeriodMultipliers||(n.customWavePeriodMultipliers={}),n.customWavePeriodMultipliers[e]=o,$.clearCustomWaveCache(),n.customWaveCount}function Un(n,e,t){let r=document.getElementById("waveform-select");if(!r)return;let o=de(),a=`${o.noteLetter}-${o.waveform}-${o.systemName}-${o.levels}`+(o.subharmonicFlag?`-${o.subharmonicFlag}`:""),s=document.createElement("option");s.textContent=`Custom ${t}: ${a}`,s.value=e,r.appendChild(s),v({currentWaveform:e}),r.value=e,w(`Successfully added new waveform: Custom ${t}. Now synthesizing with it!`,"success"),n.isPlaying&&me()}var Ee,Ce=f(()=>{E();A();N();k();xe();Ee="currentWaveformChanged"});var Q,qt=f(()=>{A();F();z();Ce();ot();Q=class extends S{constructor(e,t={}){super(e),this.mode=t.mode||"sum"}createComponent(e){return new X(e)}getProps(){let{p5Instance:e,harmonicAmplitudes:t,currentSystem:r,currentWaveform:o,customWaveCoefficients:a,isSubharmonic:s}=i;return{p5Instance:e,harmonicAmplitudes:t,currentSystem:r,currentWaveform:o,customWaveCoefficients:a,isSubharmonic:s,mode:this.mode}}bindExternalEvents(){document.addEventListener(U,()=>this.update()),document.addEventListener(W,()=>this.update()),document.addEventListener(D,()=>this.update()),document.addEventListener(q,()=>this.update()),document.addEventListener(H,()=>this.update()),document.addEventListener(Ee,()=>this.update())}}});var Me,Ht=f(()=>{L();Me=class extends x{constructor(e){super(e),this.onRoutingChange=null,this.onDownload=null}render({routingMode:e}){this.renderRoutingMode({routingMode:e})}renderRoutingMode({routingMode:e}){let t=document.getElementById("routing-mode-select");t&&(t.value=e)}bindRenderedEvents(){let e=document.getElementById("routing-mode-select");e&&this.bindEvent(e,"change",o=>{this.onRoutingChange?.(o.target.value)});let t=document.getElementById("export-wav-button");t&&this.bindEvent(t,"click",()=>{this.onDownload?.()});let r=document.getElementById("add-wave-button");r&&this.bindEvent(r,"click",()=>{this.onAddToWaveforms?.()})}setRoutingMode(e){let t=document.getElementById("routing-mode-select");t&&(t.value=e)}}});var ct,Ut=f(()=>{E();A();N();F();ct={setRoutingMode(n){i.audioRoutingMode!==n&&(v({audioRoutingMode:n}),document.dispatchEvent(new CustomEvent(fe,{detail:{mode:n}})))},handleExportWAV(n,e){V(n,e).then(t=>{Ze(t,1)}).catch(t=>{console.error("Failed to sample waveform for export:",t),w("Failed to sample waveform for export","error")})}}});var Te,zt=f(()=>{z();Ht();Ut();A();F();Ce();Te=class extends S{createComponent(e){return new Me(e)}getProps(){return{routingMode:i.audioRoutingMode,isSubharmonic:i.isSubharmonic}}bindComponentEvents(){this.component.onRoutingChange=e=>{ct.setRoutingMode(e)},this.component.onDownload=()=>{let{routingMode:e,isSubharmonic:t}=this.getProps();ct.handleExportWAV(e,t)},this.component.onAddToWaveforms=()=>{let{routingMode:e,isSubharmonic:t}=this.getProps();Vt(e,t)}}bindExternalEvents(){document.addEventListener(fe,()=>this.update())}}});var Pe,$t=f(()=>{Pe=class{static init(){let e=document.getElementById("help-button"),t=document.getElementById("help-modal"),r=document.getElementById("close-help-modal");!e||!t||!r||(e.addEventListener("click",()=>{t.classList.remove("hidden")}),r.addEventListener("click",()=>{t.classList.add("hidden")}),t.addEventListener("click",o=>{o.target===t&&t.classList.add("hidden")}),document.addEventListener("keydown",o=>{!t.classList.contains("hidden")&&(o.code==="Escape"||o.code==="Enter")&&t.classList.add("hidden")}))}}});var Ie={};Oe(Ie,{UIStateManager:()=>K});var K,ee=f(()=>{A();Fe();E();K=class n{static getState(){return i}static setFundamentalByMidi(e){let t=Math.min(127,e),r=n.midiToFreq(t),o=Math.floor(t/12)-1;v({currentMidiNote:t,fundamentalFrequency:r,currentOctave:o}),We(),De(),I()}static setFundamentalByFrequency(e){let t=Math.round(n.freqToMidi(e));n.setFundamentalByMidi(t)}static midiToFreq(e){return 440*Math.pow(2,(e-69)/12)}static freqToMidi(e){return 69+12*Math.log2(e/440)}}});var _e,Kt=f(()=>{ge();Fe();ee();_e=class{constructor(){this.focusedDrawbar=null}init(){document.addEventListener("keydown",e=>{if(e.code==="Space"){e.preventDefault(),lt();return}let r=["KeyA","KeyS","KeyD","KeyF","KeyG","KeyH","KeyJ","KeyK","KeyL","Semicolon","Quote","Backslash"].indexOf(e.code);if(r!==-1){let c=((K.getState()?.currentOctave??3)+1)*12;K.setFundamentalByMidi(c+r);return}let a=["Digit1","Digit2","Digit3","Digit4","Digit5","Digit6","Digit7","Digit8","Digit9","Digit0","Minus","Equal"].indexOf(e.code);if(a!==-1){let s=document.querySelectorAll("#drawbars .drawbar-slider");s[a]&&(s[a].focus(),this.focusedDrawbar=s[a]);return}if(this.focusedDrawbar){let s=document.querySelectorAll("#drawbars .drawbar-slider"),c=parseInt(this.focusedDrawbar.dataset.index);if(e.code==="ArrowLeft"||e.code==="ArrowRight"){e.preventDefault();let l=e.code==="ArrowLeft"?-1:1,u=(c+l+s.length)%s.length;s[u].focus(),this.focusedDrawbar=s[u];return}if(e.shiftKey&&(e.code==="ArrowUp"||e.code==="ArrowDown")){e.preventDefault();let l=e.code==="ArrowUp"?1:0;this.focusedDrawbar.value=l.toFixed(2),M.setDrawbar(c,l);return}if(e.code==="ArrowUp"||e.code==="ArrowDown"){e.preventDefault();let l=e.metaKey||e.ctrlKey?.1:.01,u=parseFloat(this.focusedDrawbar.value)+(e.code==="ArrowUp"?l:-l),d=Math.max(0,Math.min(1,u));this.focusedDrawbar.value=d.toFixed(2),M.setDrawbar(c,d);return}}!this.focusedDrawbar&&(e.ctrlKey||e.metaKey)&&(e.code==="ArrowUp"?(e.preventDefault(),window.changeOctave?.(1)):e.code==="ArrowDown"&&(e.preventDefault(),window.changeOctave?.(-1)))})}}});var te,jt=f(()=>{L();te=class extends x{constructor(e){super(e),this.input=null,this.labelEl=null}render(e={}){this.teardown(),this.props=e,this.el.innerHTML="",e.label&&(this.labelEl=document.createElement("label"),this.labelEl.textContent=e.label,this.labelEl.className="slider-label text-blue-300 text-xs md:text-sm font-medium mr-1",this.el.appendChild(this.labelEl)),this.input=document.createElement("input"),this.input.type="range",this.input.min=e.min??0,this.input.max=e.max??1,this.input.step=e.step??.01,this.input.value=e.value??0,this.input.className="slider-input w-16 md:w-24 accent-blue-400 bg-transparent rounded h-1 mx-1",this.el.appendChild(this.input),this.valueDisplay=document.createElement("span"),this.valueDisplay.className="slider-value text-blue-300 text-xs md:text-sm font-medium mr-1 min-w-12";let t=typeof e.formatValue=="function"?e.formatValue:o=>o,r=e.value!==void 0&&e.value!==null?parseFloat(e.value):0;this.valueDisplay.textContent=t(r),this.el.appendChild(this.valueDisplay),typeof e.onChange=="function"&&this.bindEvent(this.input,"input",o=>{let a=o.target.value??"",s=parseFloat(a);this.valueDisplay.textContent=t(s),e.onChange(s)})}teardown(){super.teardown(),this.input=null,this.labelEl=null,this.valueDisplay=null}}});var Yt,Zt=f(()=>{Yt={clamp(n,e,t){return Math.max(e,Math.min(t,n))}}});var _,ut=f(()=>{jt();Zt();_=class{constructor(e,t={},r=null){this.component=new te(e),this.props=t,this.onChange=r}init(){this.render(this.props)}render(e={}){this.props=e,this.component.render({...e,onChange:t=>{typeof this.onChange=="function"&&this.onChange(t)}})}setValue(e){let t=Yt.clamp(e,this.props.min,this.props.max);this.render({...this.props,value:t})}teardown(){this.component.teardown()}}});var Re,Jt=f(()=>{L();Re=class extends x{constructor(e){super(e),this.canvasId="tonewheel-canvas"}render(e){let t=this.el;if(!t)return;let r=t.querySelector("canvas");r&&r.remove(),this._p5Instance&&this._p5Instance.remove&&(this._p5Instance.remove(),this._p5Instance=null);let o=document.createElement("div");o.id=this.canvasId,t.appendChild(o),e&&e.p5Instance&&(this._p5Instance=e.p5Instance,this._p5Instance.canvas&&this._p5Instance.canvas.parentNode!==o&&o.appendChild(this._p5Instance.canvas))}teardown(){this._p5Instance&&this._p5Instance.remove&&(this._p5Instance.remove(),this._p5Instance=null);let e=this.el.querySelector(`#${this.canvasId}`);e&&e.remove(),super.teardown?.()}}});var Xt,Qt,Le,en=f(()=>{A();ut();z();Jt();xe();Le=class extends S{init(){super.init(),Xt=new _("#spread-slider-root",{min:0,max:1,step:.01,value:i.spreadFactor??.2,label:"Gain",formatValue:e=>`${(e*100).toFixed(0)}%`},e=>{$.setSpreadFactor(e)}),Xt.init(),Qt=new _("#viz-freq-slider-root",{min:.1,max:20,step:.1,value:i.visualizationFrequency??1,label:"Rate",formatValue:e=>`${e.toFixed(1)} Hz`},e=>{$.setVisualizationFrequency(e)}),Qt.init()}createComponent(e){return new Re(e)}getProps(){let e=null;return e=$.initVisualization(),{p5Instance:e}}bindComponentEvents(){}bindExternalEvents(){}}});var ke,tn=f(()=>{k();ge();ke=class{constructor(){this.lastCC={}}async init(){let e=await navigator.requestMIDIAccess();for(let t of e.inputs.values())t.onmidimessage=r=>this.route(r)}route(e){let[t,r,o]=e.data;if((t&240)===176)return this.handleCC(r,o);let s=(t&240)===144&&o>0,c=(t&240)===128||o===0;if(s)return this.handleNoteOn(r,o);if(c)return this.handleNoteOff(r)}handleCC(e,t){let r=t/127;switch(e){case 7:pe(r);break;case 10:break;default:break}this.lastCC[e]!==t&&(this.lastCC[e]=t,e>19&&e<32&&M.setDrawbar(e-20,r))}handleNoteOn(e,t){}handleNoteOff(e){}}});function dn(){Zn(),Jn(),Xn(),er(),rr(),zn(),$n(),jn(),Yn(),We(),De(),Pe.init(),new _e().init(),setTimeout(()=>{new ke().init()},2e3)}function zn(){nn=new we("#drawbars"),nn.init()}function $n(){rn=new ye("#spectral-system-root"),rn.init(),Kn()}function Kn(){cn=new Le("#tonewheel-container"),cn.init()}function jn(){an=new Q("#waveform-canvas-area"),an.init(),on=new Q("#current-waveform-canvas-area",{mode:"single"}),on.init()}function Yn(){sn=new Te("#routing-control-root"),sn.init()}function Zn(){oe("play-toggle","click",lt)}function Jn(){ln=new _("#master-gain-slider-root",{min:0,max:1,step:.01,value:i.masterGainValue,label:"Gain",formatValue:n=>`${(n*100).toFixed(0)}%`},n=>{pe(n)}),ln.init(),un=new _("#master-slew-slider-root",{min:0,max:10,step:.01,value:i.masterSlewValue,label:"Slew",formatValue:n=>{n=parseFloat(n);let e=(n*1e3).toFixed(0),t="ms";return n>1&&(e=n.toFixed(2),t="s"),`${e}${t}`}},n=>{v({masterSlewValue:n})}),un.init()}async function lt(){let n=document.getElementById("play-toggle"),e=document.getElementById("play-label");if(i.isPlaying)ue(),n.classList.remove("active"),n.setAttribute("aria-checked","false"),e.textContent="Play";else try{await le(),n.classList.add("active"),n.setAttribute("aria-checked","true"),e.textContent="Stop"}catch(t){console.error("Failed to start tone:",t),w("Failed to start audio. Please check browser permissions.","error")}}function Xn(){let n=document.getElementById("fundamental-input");n&&n.addEventListener("change",Qn),oe("octave-down","click",()=>mn(-1)),oe("octave-up","click",()=>mn(1))}function Qn(n){let e=parseFloat(n.target.value);(isNaN(e)||e<.01||e>1e4)&&(w("Frequency must be between 0.01 Hz and 10000 Hz.","error"),e=i.fundamentalFrequency),Promise.resolve().then(()=>(ee(),Ie)).then(({UIStateManager:t})=>{t.setFundamentalByFrequency(e),n.target.value=e.toFixed(2)})}function mn(n){Promise.resolve().then(()=>(ee(),Ie)).then(({UIStateManager:e})=>{let r=e.getState().currentMidiNote+n*12;e.setFundamentalByMidi(r)})}function We(){$e("fundamental-input",i.fundamentalFrequency.toFixed(2)),ze("current-octave-display",`Octave ${i.currentOctave}`)}function er(){let n=document.getElementById("piano-keyboard");if(!n)return;let e=[{name:"C",class:"white",index:0},{name:"C#",class:"black",index:1},{name:"D",class:"white",index:2},{name:"D#",class:"black",index:3},{name:"E",class:"white",index:4},{name:"F",class:"white",index:5},{name:"F#",class:"black",index:6},{name:"G",class:"white",index:7},{name:"G#",class:"black",index:8},{name:"A",class:"white",index:9},{name:"A#",class:"black",index:10},{name:"B",class:"white",index:11}];n.innerHTML="",e.forEach(t=>{let r=document.createElement("div");r.className=`key ${t.class}`,r.textContent=t.name,r.dataset.noteIndex=t.index,r.addEventListener("click",()=>tr(t.index)),n.appendChild(r)})}function tr(n){Promise.resolve().then(()=>(ee(),Ie)).then(({UIStateManager:e})=>{let o=(e.getState().currentOctave+1)*12+n;e.setFundamentalByMidi(o)})}function De(){document.querySelectorAll(".key").forEach(r=>r.classList.remove("active"));let e=i.currentMidiNote%12;e<0&&(e+=12);let t=document.querySelector(`.key[data-note-index="${e}"]`);t&&t.classList.add("active")}function nr(){ze("system-description",i.currentSystem.description,!0)}function rr(){let n=document.getElementById("waveform-select");n&&n.addEventListener("change",Gt)}function mt(){We(),De(),nr();let n=document.getElementById("play-button");n&&(n.textContent=i.isPlaying?"Stop Tone":"Start Tone",n.classList.toggle("playing",i.isPlaying)),$e("waveform-select",i.currentWaveform)}var nn,rn,on,an,sn,cn,ln,un,Fe=f(()=>{A();N();Rt();Bt();qt();Ce();zt();$t();Kt();en();E();k();ut();tn()});A();ne();Fe();N();var dt=class{constructor(){this.interval=null,this.faviconId="dynamic-favicon"}start(){this.interval||(this.updateFavicon(),this.interval=setInterval(()=>this.updateFavicon(),100))}stop(){this.interval&&(clearInterval(this.interval),this.interval=null)}updateFavicon(){let e=document.getElementById("tonewheel-container");if(!e)return;let t=e.querySelector("canvas");if(t)try{let o=document.createElement("canvas");o.width=128,o.height=128;let a=o.getContext("2d"),s=t.width,c=t.height,l=s*.25,u=c*.25,d=s*.5,m=c*.5;a.drawImage(t,l,u,d,m,0,0,128,128);let h=a.getImageData(0,0,128,128);this.increaseBrightness(h.data,50),this.increaseContrast(h.data,2),a.putImageData(h,0,0);let p=o.toDataURL("image/png");this.setFavicon(p)}catch{}}increaseBrightness(e,t=128){for(let r=0;r<e.length;r+=4)for(let o=0;o<3;o++)e[r+o]=Math.max(0,Math.min(255,e[r+o]+t))}increaseContrast(e,t=1.2){for(let o=0;o<e.length;o+=4)for(let a=0;a<3;a++)e[o+a]=Math.max(0,Math.min(255,128+t*(e[o+a]-128)))}setFavicon(e){document.querySelectorAll('link[rel~="icon"]').forEach(o=>{o.id!==this.faviconId&&o.parentNode.removeChild(o)});let r=document.getElementById(this.faviconId);r||(r=document.createElement("link"),r.id=this.faviconId,r.rel="icon",document.head.appendChild(r)),r.type="image/png",r.href=e}},ht=new dt;typeof window<"u"&&window.addEventListener("DOMContentLoaded",()=>ht.start());E();function or(){try{dn(),ht.start(),mt()}catch(n){console.error("Failed to initialize application:",n),w("Failed to initialize application. Please refresh the page.","error")}}function ar(){window.addEventListener("error",n=>{console.error("Application error:",n.error),w("An unexpected error occurred. Please check the console.","error")}),window.addEventListener("unhandledrejection",n=>{console.error("Unhandled promise rejection:",n.reason),w("A promise was rejected. Please check the console.","error")})}function pt(){try{T.clear(),i.isPlaying&&i.audioContext&&i.oscillators.forEach(n=>{n.osc&&(n.osc.stop(),n.osc.disconnect(),n.gainNode.disconnect())}),i.audioContext&&i.audioContext.state!=="closed"&&i.audioContext.close(),console.log("Application cleaned up successfully")}catch(n){console.error("Error during cleanup:",n)}}function ir(){window.addEventListener("beforeunload",pt),window.addEventListener("pagehide",pt)}function sr(){let n=[];if(!window.AudioContext&&!window.webkitAudioContext&&n.push("Web Audio API not supported"),window.Promise||n.push("ES6 Promises not supported"),n.length>0){let e=`Browser compatibility issues: ${n.join(", ")}. Please use a modern browser.`;return w(e,"error"),console.error(e),!1}if(!navigator.requestMIDIAccess){let e="Web MIDI API not supported in this browser. MIDI functionality will be disabled.";w(e,"warning"),console.warn(e)}return!0}function hn(){ar(),sr()&&(ir(),or())}window.TWIG={getState:()=>i,getAudioCtx:()=>Ye().getContext(),updateUI:mt,showStatus:w,cleanup:pt};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",hn):hn();
